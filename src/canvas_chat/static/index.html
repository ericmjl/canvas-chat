<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Chat</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js"></script>
    <!-- marked-katex-extension -->
    <script src="https://cdn.jsdelivr.net/npm/marked-katex-extension@5.1.5/lib/index.umd.js"></script>
</head>
<body>
    <!-- Top Toolbar -->
    <div id="toolbar">
        <div class="toolbar-left">
            <h1 class="logo">Canvas Chat</h1>
            <div class="session-name" id="session-name">Untitled Session</div>
            <button id="auto-title-btn" class="icon-btn auto-title-btn" title="Generate title from conversation">‚ú®</button>
        </div>
        <div class="toolbar-center">
            <div class="context-budget" id="context-budget">
                <span class="budget-label">Context:</span>
                <div class="budget-bar">
                    <div class="budget-fill" id="budget-fill" style="width: 0%"></div>
                </div>
                <span class="budget-text" id="budget-text">0 / 128k</span>
            </div>
        </div>
        <div class="toolbar-right">
            <select id="model-picker" class="model-picker">
                <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
            </select>
            <div class="layout-controls">
                <select id="layout-picker" class="layout-picker" title="Layout Algorithm">
                    <option value="hierarchical">Hierarchical</option>
                    <option value="force">Force-Directed</option>
                </select>
                <button id="auto-layout-btn" class="icon-btn" title="Apply Layout">üîÄ</button>
            </div>
            <div class="undo-redo-controls">
                <button id="undo-btn" class="icon-btn" title="Undo (Cmd/Ctrl+Z)" disabled>‚Ü∂</button>
                <button id="redo-btn" class="icon-btn" title="Redo (Cmd/Ctrl+Shift+Z)" disabled>‚Ü∑</button>
            </div>
            <div class="multiplayer-controls">
                <button id="multiplayer-btn" class="icon-btn multiplayer-btn" title="Enable multiplayer sync">üë•</button>
                <button id="multiplayer-leave-btn" class="icon-btn multiplayer-leave-btn" title="Leave multiplayer session" style="display: none;">‚úï</button>
                <span id="peer-count" class="peer-count" style="display: none;">0</span>
            </div>
            <button id="tags-btn" class="icon-btn" title="Tags">üè∑Ô∏è</button>
            <button id="search-btn" class="icon-btn" title="Search nodes (Cmd/Ctrl+K)">üîç</button>
            <button id="new-canvas-btn" class="icon-btn" title="New Canvas">üìÑ</button>
            <button id="sessions-btn" class="icon-btn" title="Sessions">üìö</button>
            <button id="settings-btn" class="icon-btn" title="Settings">‚öôÔ∏è</button>
            <button id="help-btn" class="icon-btn" title="Help (?)">‚ùì</button>
            <button id="export-btn" class="icon-btn" title="Export">üíæ</button>
            <button id="import-btn" class="icon-btn" title="Import">üìÇ</button>
        </div>
    </div>

    <!-- Main Canvas Area -->
    <div id="canvas-container">
        <svg id="canvas" width="100%" height="100%">
            <!-- Arrow marker definitions -->
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#999" />
                </marker>
                <marker id="arrowhead-cell" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6" />
                </marker>
            </defs>
            <!-- Edges layer (below nodes) -->
            <g id="edges-layer"></g>
            <!-- Nodes layer -->
            <g id="nodes-layer"></g>
        </svg>

        <!-- Hint overlay when no nodes visible -->
        <div id="no-nodes-hint" class="no-nodes-hint" style="display: none;">
            <div class="hint-content">
                <span class="hint-icon">üëÜ</span>
                <span class="hint-text">Double-click to zoom out and see all nodes</span>
            </div>
        </div>

        <!-- Drop zone overlay for file drag & drop -->
        <div id="drop-zone-overlay" class="drop-zone-overlay" style="display: none;">
            <div class="drop-zone-content">
                <span class="drop-zone-icon">üìé</span>
                <span class="drop-zone-text">Drop file here</span>
            </div>
        </div>

        <!-- Node template (cloned when creating nodes) -->
        <template id="node-template">
            <foreignObject class="node-wrapper" width="320" height="auto">
                <div class="node" xmlns="http://www.w3.org/1999/xhtml">
                    <div class="node-header">
                        <span class="node-type"></span>
                        <span class="node-model"></span>
                    </div>
                    <div class="node-content"></div>
                    <div class="node-actions">
                        <button class="node-action reply-btn" title="Reply">‚Ü©Ô∏è</button>
                        <button class="node-action branch-btn" title="Branch from selection">üåø</button>
                        <button class="node-action summarize-btn" title="Summarize">üìù</button>
                    </div>
                </div>
            </foreignObject>
        </template>
    </div>

    <!-- Canvas hint (temporary notification) -->
    <div id="canvas-hint" class="canvas-hint" style="display: none;">
        <span class="hint-text"></span>
    </div>

    <!-- Tag Drawer (Right Side) -->
    <div id="tag-drawer" class="tag-drawer">
        <div class="tag-drawer-header">
            <h3>Tags</h3>
            <button id="tag-drawer-close" class="icon-btn" title="Close">‚úï</button>
        </div>
        <div class="tag-drawer-content">
            <div id="tag-slots" class="tag-slots">
                <!-- Tag slots will be populated by JS -->
            </div>
        </div>
        <div class="tag-drawer-footer" id="tag-drawer-footer">
            <span id="tag-selection-status">Select nodes to apply tags</span>
        </div>
    </div>

    <!-- Chat Input (floating at bottom) -->
    <div id="chat-input-container">
        <div class="selected-nodes-indicator" id="selected-nodes-indicator" style="display: none;">
            Responding to <span id="selected-count">0</span> node(s)
            <button id="clear-selection-btn">‚úï</button>
        </div>
        <div class="chat-input-wrapper">
            <button id="attach-btn" class="attach-btn" title="Attach PDF or image (drag & drop also supported)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                </svg>
            </button>
            <textarea
                id="chat-input"
                placeholder="Type a message... (Enter to send, Shift+Enter for newline)"
                rows="1"
            ></textarea>
            <button id="send-btn" class="send-btn" title="Send">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13"></path>
                    <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="modal-close" id="settings-close">&times;</button>
            </div>
            <div class="modal-body">
                <h3>API Keys</h3>
                <p class="settings-note">Keys are stored locally in your browser and sent directly to providers.</p>

                <div class="api-key-group">
                    <label for="openai-key">OpenAI API Key</label>
                    <input type="password" id="openai-key" placeholder="sk-...">
                </div>

                <div class="api-key-group">
                    <label for="anthropic-key">Anthropic API Key</label>
                    <input type="password" id="anthropic-key" placeholder="sk-ant-...">
                </div>

                <div class="api-key-group">
                    <label for="google-key">Google AI API Key</label>
                    <input type="password" id="google-key" placeholder="AI...">
                </div>

                <div class="api-key-group">
                    <label for="groq-key">Groq API Key</label>
                    <input type="password" id="groq-key" placeholder="gsk_...">
                </div>

                <div class="api-key-group">
                    <label for="github-key">GitHub Token (for GitHub Models)</label>
                    <input type="password" id="github-key" placeholder="ghp_... or github_pat_...">
                    <small class="key-hint">PAT with <code>models:read</code> scope. <a href="https://github.com/settings/tokens" target="_blank">Create token</a></small>
                </div>

                <div class="api-key-group copilot-note">
                    <strong>GitHub Copilot Models</strong>
                    <small class="key-hint">Copilot models (e.g., <code>github_copilot/gpt-4</code>) require device authentication. On first use, check your <strong>server terminal</strong> for a device code and URL to authenticate with GitHub.</small>
                </div>

                <div class="api-key-group">
                    <label for="exa-key">Exa API Key (for web search)</label>
                    <input type="password" id="exa-key" placeholder="exa-...">
                    <small class="key-hint">Use <code>/search query</code> to search the web. <a href="https://dashboard.exa.ai/api-keys" target="_blank">Get API key</a></small>
                </div>

                <h3>LLM Proxy</h3>
                <p class="settings-note">Configure a custom base URL to use your own LLM proxy (e.g., LiteLLM proxy, OpenRouter).</p>

                <div class="api-key-group">
                    <label for="base-url">Base URL (optional)</label>
                    <input type="text" id="base-url" placeholder="https://your-proxy.example.com/v1">
                    <small class="key-hint">Leave empty to use default provider endpoints. Supports OpenAI-compatible APIs.</small>
                </div>

                <h3>Custom Models</h3>
                <p class="settings-note">Add LiteLLM-compatible models for self-hosted or proxy endpoints.</p>

                <div id="custom-models-list" class="custom-models-list">
                    <!-- Custom models will be populated here -->
                </div>

                <div class="custom-model-form">
                    <div class="api-key-group">
                        <label for="custom-model-id">Model ID *</label>
                        <input type="text" id="custom-model-id" placeholder="openai/gpt-4.1-mini">
                        <small class="key-hint">Format: provider/model-name (e.g., openai/my-model, ollama_chat/llama3.1)</small>
                    </div>
                    <div class="api-key-group">
                        <label for="custom-model-name">Display Name</label>
                        <input type="text" id="custom-model-name" placeholder="My Custom Model">
                        <small class="key-hint">Optional. Defaults to model ID if not specified.</small>
                    </div>
                    <div class="custom-model-form-row">
                        <div class="api-key-group">
                            <label for="custom-model-context">Context Window</label>
                            <input type="number" id="custom-model-context" placeholder="128000" min="1">
                        </div>
                        <div class="api-key-group">
                            <label for="custom-model-baseurl">Base URL</label>
                            <input type="text" id="custom-model-baseurl" placeholder="https://my-proxy.com/v1">
                        </div>
                    </div>
                    <button id="add-custom-model-btn" class="secondary-btn">+ Add Model</button>
                </div>

                <h3>Flashcard Settings</h3>
                <p class="settings-note">Configure how flashcard answers are graded during review.</p>

                <div class="api-key-group">
                    <label for="flashcard-strictness">Grading Strictness</label>
                    <select id="flashcard-strictness" class="settings-select">
                        <option value="lenient">Lenient (gist is enough)</option>
                        <option value="medium" selected>Medium (key concepts required)</option>
                        <option value="strict">Strict (precise answer required)</option>
                    </select>
                    <small class="key-hint">Controls how strictly the AI grades your flashcard answers</small>
                </div>

                <button id="save-settings-btn" class="primary-btn">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Session Picker Modal -->
    <div id="session-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Sessions</h2>
                <button class="modal-close" id="session-close">&times;</button>
            </div>
            <div class="modal-body">
                <button id="new-session-btn" class="primary-btn">+ New Session</button>
                <div id="session-list" class="session-list">
                    <!-- Sessions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="import-file-input" accept=".canvaschat" style="display: none;">

    <!-- Hidden file input for PDF and image upload -->
    <input type="file" id="pdf-file-input" accept=".pdf,application/pdf,image/*" style="display: none;">

    <!-- Matrix Axis Confirmation Modal -->
    <div id="matrix-modal" class="modal" style="display: none;">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2>Create Matrix</h2>
                <button class="modal-close" id="matrix-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="matrix-context-group">
                    <label for="matrix-context">Matrix Context</label>
                    <input type="text" id="matrix-context" placeholder="e.g., evaluate ideas against criteria" readonly>
                </div>

                <div id="matrix-loading" class="matrix-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span>Extracting rows and columns...</span>
                </div>

                <div class="matrix-axes">
                    <div class="matrix-axis">
                        <div class="axis-header">
                            <h3>Rows</h3>
                            <span class="axis-count" id="row-count">0 items</span>
                        </div>
                        <ul class="axis-items" id="row-items">
                            <!-- Row items will be populated here -->
                        </ul>
                        <button class="axis-add-btn" id="add-row-btn">+ Add row</button>
                    </div>

                    <div class="matrix-swap">
                        <button id="swap-axes-btn" class="icon-btn" title="Swap Axes">‚áÑ</button>
                    </div>

                    <div class="matrix-axis">
                        <div class="axis-header">
                            <h3>Columns</h3>
                            <span class="axis-count" id="col-count">0 items</span>
                        </div>
                        <ul class="axis-items" id="col-items">
                            <!-- Column items will be populated here -->
                        </ul>
                        <button class="axis-add-btn" id="add-col-btn">+ Add column</button>
                    </div>
                </div>

                <div class="matrix-warning" id="matrix-warning" style="display: none;">
                    ‚ö†Ô∏è Maximum 10 items per axis. Some items have been truncated.
                </div>

                <div class="modal-actions">
                    <button id="matrix-cancel-btn" class="secondary-btn">Cancel</button>
                    <button id="matrix-create-btn" class="primary-btn">Create Matrix</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Matrix Modal -->
    <div id="edit-matrix-modal" class="modal" style="display: none;">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2>Edit Matrix</h2>
                <button class="modal-close" id="edit-matrix-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="matrix-axes">
                    <div class="matrix-axis">
                        <div class="axis-header">
                            <h3>Rows</h3>
                            <span class="axis-count" id="edit-row-count">0 items</span>
                        </div>
                        <ul class="axis-items" id="edit-row-items">
                        </ul>
                        <button class="axis-add-btn" id="edit-add-row-btn">+ Add row</button>
                    </div>

                    <div class="matrix-swap">
                        <button id="edit-swap-axes-btn" class="icon-btn" title="Swap Axes">‚áÑ</button>
                    </div>

                    <div class="matrix-axis">
                        <div class="axis-header">
                            <h3>Columns</h3>
                            <span class="axis-count" id="edit-col-count">0 items</span>
                        </div>
                        <ul class="axis-items" id="edit-col-items">
                        </ul>
                        <button class="axis-add-btn" id="edit-add-col-btn">+ Add column</button>
                    </div>
                </div>

                <div class="modal-actions">
                    <button id="edit-matrix-cancel-btn" class="secondary-btn">Cancel</button>
                    <button id="edit-matrix-save-btn" class="primary-btn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cell Detail Modal -->
    <div id="cell-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cell Details</h2>
                <button class="modal-close" id="cell-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="cell-detail-row">
                    <label>Row:</label>
                    <div class="cell-detail-content" id="cell-row-item"></div>
                </div>
                <div class="cell-detail-row">
                    <label>Column:</label>
                    <div class="cell-detail-content" id="cell-col-item"></div>
                </div>
                <div class="cell-detail-row">
                    <label>Evaluation: <button id="cell-copy-btn" class="cell-copy-btn" title="Copy evaluation">üìã</button></label>
                    <div class="cell-detail-content cell-evaluation" id="cell-content"></div>
                </div>
                <div class="modal-actions">
                    <button id="cell-close-btn" class="secondary-btn">Close</button>
                    <button id="cell-pin-btn" class="primary-btn">üìå Pin to Canvas</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Row/Column Detail Modal -->
    <div id="slice-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="slice-title">Row Details</h2>
                <button class="modal-close" id="slice-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="cell-detail-row">
                    <label id="slice-label">Row:</label>
                    <div class="cell-detail-content" id="slice-item"></div>
                </div>
                <div class="cell-detail-row">
                    <label>Contents: <button id="slice-copy-btn" class="cell-copy-btn" title="Copy contents">üìã</button></label>
                    <div class="cell-detail-content cell-evaluation slice-content" id="slice-content"></div>
                </div>
                <div class="modal-actions">
                    <button id="slice-close-btn" class="secondary-btn">Close</button>
                    <button id="slice-pin-btn" class="primary-btn">üìå Pin to Canvas</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Overlay -->
    <div id="search-overlay" class="search-overlay" style="display: none;">
        <div class="search-container">
            <div class="search-input-wrapper">
                <span class="search-icon">üîç</span>
                <input
                    type="text"
                    id="search-input"
                    class="search-input"
                    placeholder="Search nodes..."
                    autocomplete="off"
                >
                <kbd class="search-hint">esc</kbd>
            </div>
            <div id="search-results" class="search-results">
                <div class="search-empty">Type to search through your nodes</div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal" style="display: none;">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2>Help</h2>
                <button class="modal-close" id="help-close">&times;</button>
            </div>
            <div class="modal-body help-content">
                <section class="help-section">
                    <h3>Getting Started</h3>
                    <ul>
                        <li>Type a message and press <kbd>Enter</kbd> to start a conversation</li>
                        <li>Click on a node to select it, then type to reply</li>
                        <li><kbd>Ctrl</kbd>/<kbd>Cmd</kbd> + click to select multiple nodes</li>
                        <li>Drag the canvas to pan, scroll to zoom</li>
                        <li>Double-click empty space to fit all nodes in view</li>
                    </ul>
                </section>

                <section class="help-section">
                    <h3>Keyboard Shortcuts</h3>
                    <table class="shortcuts-table">
                        <tbody>
                            <tr><td><kbd>Ctrl</kbd>/<kbd>Cmd</kbd> + <kbd>K</kbd></td><td>Search nodes</td></tr>
                            <tr><td><kbd>Ctrl</kbd>/<kbd>Cmd</kbd> + <kbd>Z</kbd></td><td>Undo</td></tr>
                            <tr><td><kbd>Ctrl</kbd>/<kbd>Cmd</kbd> + <kbd>Shift</kbd> + <kbd>Z</kbd></td><td>Redo</td></tr>
                            <tr><td><kbd>Delete</kbd> / <kbd>Backspace</kbd></td><td>Delete selected nodes</td></tr>
                            <tr><td><kbd>R</kbd></td><td>Focus reply input (when node selected)</td></tr>
                            <tr><td><kbd>C</kbd></td><td>Copy node content (when node selected)</td></tr>
                            <tr><td><kbd>F</kbd></td><td>Fit node to viewport (when node selected)</td></tr>
                            <tr><td><kbd>Escape</kbd></td><td>Clear selection / Close dialogs</td></tr>
                            <tr><td><kbd>Enter</kbd></td><td>Send message</td></tr>
                            <tr><td><kbd>Shift</kbd> + <kbd>Enter</kbd></td><td>New line in message</td></tr>
                            <tr><td><kbd>?</kbd></td><td>Show this help</td></tr>
                        </tbody>
                    </table>
                </section>

                <section class="help-section">
                    <h3>Slash Commands</h3>
                    <table class="shortcuts-table">
                        <tbody>
                            <tr><td><code>/note</code> <em>text or URL</em></td><td>Create a note (supports PDF URLs)</td></tr>
                            <tr><td><code>/search</code> <em>query</em></td><td>Search the web with Exa AI</td></tr>
                            <tr><td><code>/research</code> <em>topic</em></td><td>Deep research with multiple sources</td></tr>
                            <tr><td><code>/matrix</code> <em>context</em></td><td>Create a comparison matrix</td></tr>
                            <tr><td><code>/committee</code> <em>question</em></td><td>Consult multiple LLMs and synthesize</td></tr>
                        </tbody>
                    </table>
                </section>

                <section class="help-section">
                    <h3>Tips</h3>
                    <ul>
                        <li><strong>Branching:</strong> Select text in a node to create a branch from that specific point</li>
                        <li><strong>Semantic zoom:</strong> Zoom out to see node summaries instead of full content</li>
                        <li><strong>Context:</strong> The context budget bar shows how much of the model's context window is used</li>
                        <li><strong>Tags:</strong> Use the üè∑Ô∏è button to organize nodes with colored tags</li>
                        <li><strong>Stop generation:</strong> Click "‚èπ Stop" on an AI response to stop and optionally continue later</li>
                        <li><strong>PDF import:</strong> Click üìé to upload a PDF, or drag & drop onto the canvas</li>
                    </ul>
                </section>
            </div>
        </div>
    </div>

    <!-- Edit Content Modal -->
    <div id="edit-content-modal" class="modal" style="display: none;">
        <div class="modal-content modal-extra-wide">
            <div class="modal-header">
                <h2>Edit Content</h2>
                <button class="modal-close" id="edit-content-close">&times;</button>
            </div>
            <div class="modal-body edit-content-body">
                <div class="edit-content-pane edit-pane">
                    <div class="pane-header">Markdown</div>
                    <textarea id="edit-content-textarea" placeholder="Edit the fetched content..."></textarea>
                </div>
                <div class="edit-content-pane preview-pane">
                    <div class="pane-header">Preview</div>
                    <div id="edit-content-preview" class="node-content"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="secondary-btn" id="edit-content-cancel">Cancel</button>
                <button class="primary-btn" id="edit-content-save">Save</button>
            </div>
        </div>
    </div>

    <!-- Committee Modal -->
    <div id="committee-modal" class="modal" style="display: none;">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2>LLM Committee</h2>
                <button class="modal-close" id="committee-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="committee-question-group">
                    <label for="committee-question">Question</label>
                    <textarea id="committee-question" rows="3" readonly placeholder="Your question will appear here..."></textarea>
                </div>

                <div class="committee-models-group">
                    <div class="committee-models-header">
                        <label>Committee Members</label>
                        <span class="committee-models-count" id="committee-models-count">0 selected (2-5 required)</span>
                    </div>
                    <div class="committee-models-grid" id="committee-models-grid">
                        <!-- Model checkboxes will be populated by JS -->
                    </div>
                </div>

                <div class="committee-chairman-group">
                    <label for="committee-chairman">Chairman (synthesizes opinions)</label>
                    <select id="committee-chairman" class="committee-chairman-select">
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div class="committee-options-group">
                    <label class="committee-checkbox-label">
                        <input type="checkbox" id="committee-include-review">
                        <span class="checkbox-text">Include review stage</span>
                        <span class="checkbox-hint">Each model reviews all other opinions before synthesis</span>
                    </label>
                </div>

                <div class="modal-actions">
                    <button id="committee-cancel-btn" class="secondary-btn">Cancel</button>
                    <button id="committee-execute-btn" class="primary-btn" disabled>Consult Committee</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Title Modal -->
    <div id="edit-title-modal" class="modal" style="display: none;">
        <div class="modal-content modal-narrow">
            <div class="modal-header">
                <h2>Edit Title</h2>
                <button class="modal-close" id="edit-title-close">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="edit-title-input" class="modal-text-input" placeholder="Enter title..." />
            </div>
            <div class="modal-actions">
                <button class="secondary-btn" id="edit-title-cancel">Cancel</button>
                <button class="primary-btn" id="edit-title-save">Save</button>
            </div>
        </div>
    </div>

    <!-- Flashcard Generation Modal -->
    <div id="flashcard-generation-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Generate Flashcards</h2>
                <button class="modal-close" id="flashcard-generation-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="flashcard-generation-status" class="flashcard-status-message">
                    Generating flashcards...
                </div>
                <div id="flashcard-candidates" class="flashcard-candidates-list">
                    <!-- Candidate cards listed here -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="secondary-btn" id="flashcard-cancel">Cancel</button>
                <button class="primary-btn" id="flashcard-accept-selected" disabled>Accept Selected</button>
            </div>
        </div>
    </div>

    <!-- Flashcard Review Modal -->
    <div id="flashcard-review-modal" class="modal" style="display: none;">
        <div class="modal-content review-modal-content">
            <div class="modal-header">
                <h2>Review Flashcards <span id="review-progress" class="review-progress">1/5</span></h2>
                <button class="modal-close" id="flashcard-review-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="review-question" class="review-question"></div>
                <textarea id="review-answer-input" class="review-answer-input" placeholder="Type your answer..."></textarea>
                <button id="review-submit" class="primary-btn review-submit-btn">Submit Answer</button>

                <!-- Shown after submit -->
                <div id="review-result" class="review-result" style="display: none;">
                    <div class="review-correct-answer">
                        <div class="review-label">Correct Answer:</div>
                        <div id="review-correct-answer-text"></div>
                    </div>
                    <div id="review-verdict" class="review-verdict"></div>
                    <div id="review-explanation" class="review-explanation"></div>
                    <div class="review-override-buttons">
                        <button id="review-override-correct" class="override-btn correct">I knew this</button>
                        <button id="review-override-incorrect" class="override-btn incorrect">I didn't know this</button>
                    </div>
                </div>
            </div>
            <div class="modal-actions review-actions">
                <button class="secondary-btn" id="review-end">End Review</button>
                <button class="primary-btn" id="review-next" style="display: none;">Next Card</button>
            </div>
        </div>
    </div>

    <!-- Flashcard Due Toast Notification -->
    <div id="flashcard-due-toast" class="due-toast" style="display: none;">
        <span id="due-toast-message"></span>
        <div class="due-toast-buttons">
            <button id="due-toast-review" class="toast-btn primary">Review Now</button>
            <button id="due-toast-later" class="toast-btn secondary">Later</button>
        </div>
    </div>

    <!-- Factcheck Claims Selection Modal -->
    <div id="factcheck-modal" class="modal" style="display: none;">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2>Select Claims to Verify</h2>
                <button class="modal-close" id="factcheck-close">&times;</button>
            </div>
            <div class="modal-body">
                <p class="factcheck-modal-subtitle" id="factcheck-modal-subtitle">Found multiple claims. Select which ones to fact-check (max 5):</p>

                <div class="factcheck-select-all-group">
                    <label class="factcheck-checkbox-label">
                        <input type="checkbox" id="factcheck-select-all">
                        <span class="checkbox-text">Select All</span>
                    </label>
                </div>

                <div class="factcheck-claims-list" id="factcheck-claims-list">
                    <!-- Claim checkboxes will be populated by JS -->
                </div>

                <div class="factcheck-selection-info">
                    <span class="factcheck-selection-count" id="factcheck-selection-count">0 of 0 selected</span>
                    <span class="factcheck-limit-warning" id="factcheck-limit-warning" style="display: none;">Maximum 5 claims allowed</span>
                </div>

                <div class="modal-actions">
                    <button id="factcheck-cancel-btn" class="secondary-btn">Cancel</button>
                    <button id="factcheck-execute-btn" class="primary-btn" disabled>Verify Selected</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Yjs CRDT library for collaborative editing -->
    <!-- Use import map to ensure single Yjs instance (y-indexeddb must use same Yjs) -->
    <script type="importmap">
    {
        "imports": {
            "yjs": "https://esm.sh/yjs@13.6.24",
            "y-indexeddb": "https://esm.sh/y-indexeddb@9.0.12?external=yjs",
            "y-webrtc": "https://esm.sh/y-webrtc@10.3.0?external=yjs"
        }
    }
    </script>
    <script type="module">
        // Import Yjs and providers using import map
        // The ?external=yjs flag ensures providers use our single Yjs instance
        import * as Y from 'yjs';
        import { IndexeddbPersistence } from 'y-indexeddb';
        import { WebrtcProvider } from 'y-webrtc';

        // Expose globally for non-module scripts
        window.Y = Y;
        window.IndexeddbPersistence = IndexeddbPersistence;
        window.WebrtcProvider = WebrtcProvider;

        // Signal that Yjs is ready
        window.dispatchEvent(new CustomEvent('yjs-ready'));
    </script>

    <!-- Scripts (loaded after Yjs is ready) -->
    <script src="/static/js/sse.js"></script>
    <script src="/static/js/search.js"></script>
    <script src="/static/js/storage.js"></script>
    <script src="/static/js/layout.js"></script>
    <script src="/static/js/highlight-utils.js"></script>
    <script src="/static/js/graph.js"></script>
    <script src="/static/js/crdt-graph.js"></script>
    <script src="/static/js/node-protocols.js"></script>
    <script src="/static/js/canvas.js"></script>
    <script src="/static/js/chat.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
