<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Chat</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <!-- Top Toolbar -->
    <div id="toolbar">
        <div class="toolbar-left">
            <h1 class="logo">Canvas Chat</h1>
            <div class="session-name" id="session-name">Untitled Session</div>
        </div>
        <div class="toolbar-center">
            <div class="context-budget" id="context-budget">
                <span class="budget-label">Context:</span>
                <div class="budget-bar">
                    <div class="budget-fill" id="budget-fill" style="width: 0%"></div>
                </div>
                <span class="budget-text" id="budget-text">0 / 128k</span>
            </div>
        </div>
        <div class="toolbar-right">
            <select id="model-picker" class="model-picker">
                <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
            </select>
            <div class="layout-controls">
                <select id="layout-picker" class="layout-picker" title="Layout Algorithm">
                    <option value="hierarchical">Hierarchical</option>
                    <option value="force">Force-Directed</option>
                </select>
                <button id="auto-layout-btn" class="icon-btn" title="Apply Layout">üîÄ</button>
            </div>
            <button id="tags-btn" class="icon-btn" title="Tags">üè∑Ô∏è</button>
            <button id="new-canvas-btn" class="icon-btn" title="New Canvas">üìÑ</button>
            <button id="sessions-btn" class="icon-btn" title="Sessions">üìö</button>
            <button id="settings-btn" class="icon-btn" title="Settings">‚öôÔ∏è</button>
            <button id="export-btn" class="icon-btn" title="Export">üíæ</button>
            <button id="import-btn" class="icon-btn" title="Import">üìÇ</button>
        </div>
    </div>

    <!-- Main Canvas Area -->
    <div id="canvas-container">
        <svg id="canvas" width="100%" height="100%">
            <!-- Edges layer (below nodes) -->
            <g id="edges-layer"></g>
            <!-- Nodes layer -->
            <g id="nodes-layer"></g>
        </svg>
        
        <!-- Node template (cloned when creating nodes) -->
        <template id="node-template">
            <foreignObject class="node-wrapper" width="320" height="auto">
                <div class="node" xmlns="http://www.w3.org/1999/xhtml">
                    <div class="node-header">
                        <span class="node-type"></span>
                        <span class="node-model"></span>
                    </div>
                    <div class="node-content"></div>
                    <div class="node-actions">
                        <button class="node-action reply-btn" title="Reply">‚Ü©Ô∏è</button>
                        <button class="node-action branch-btn" title="Branch from selection">üåø</button>
                        <button class="node-action summarize-btn" title="Summarize">üìù</button>
                    </div>
                </div>
            </foreignObject>
        </template>
    </div>
    
    <!-- Tag Drawer (Right Side) -->
    <div id="tag-drawer" class="tag-drawer">
        <div class="tag-drawer-header">
            <h3>Tags</h3>
            <button id="tag-drawer-close" class="icon-btn" title="Close">‚úï</button>
        </div>
        <div class="tag-drawer-content">
            <div id="tag-slots" class="tag-slots">
                <!-- Tag slots will be populated by JS -->
            </div>
        </div>
        <div class="tag-drawer-footer" id="tag-drawer-footer">
            <span id="tag-selection-status">Select nodes to apply tags</span>
        </div>
    </div>

    <!-- Chat Input (floating at bottom) -->
    <div id="chat-input-container">
        <div class="selected-nodes-indicator" id="selected-nodes-indicator" style="display: none;">
            Responding to <span id="selected-count">0</span> node(s)
            <button id="clear-selection-btn">‚úï</button>
        </div>
        <div class="chat-input-wrapper">
            <textarea 
                id="chat-input" 
                placeholder="Type a message... (Enter to send, Shift+Enter for newline)"
                rows="1"
            ></textarea>
            <button id="send-btn" class="send-btn" title="Send">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13"></path>
                    <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="modal-close" id="settings-close">&times;</button>
            </div>
            <div class="modal-body">
                <h3>API Keys</h3>
                <p class="settings-note">Keys are stored locally in your browser and sent directly to providers.</p>
                
                <div class="api-key-group">
                    <label for="openai-key">OpenAI API Key</label>
                    <input type="password" id="openai-key" placeholder="sk-...">
                </div>
                
                <div class="api-key-group">
                    <label for="anthropic-key">Anthropic API Key</label>
                    <input type="password" id="anthropic-key" placeholder="sk-ant-...">
                </div>
                
                <div class="api-key-group">
                    <label for="google-key">Google AI API Key</label>
                    <input type="password" id="google-key" placeholder="AI...">
                </div>
                
                <div class="api-key-group">
                    <label for="groq-key">Groq API Key</label>
                    <input type="password" id="groq-key" placeholder="gsk_...">
                </div>
                
                <div class="api-key-group">
                    <label for="github-key">GitHub Token (for GitHub Models)</label>
                    <input type="password" id="github-key" placeholder="ghp_... or github_pat_...">
                    <small class="key-hint">PAT with <code>models:read</code> scope. <a href="https://github.com/settings/tokens" target="_blank">Create token</a></small>
                </div>
                
                <div class="api-key-group">
                    <label for="exa-key">Exa API Key (for web search)</label>
                    <input type="password" id="exa-key" placeholder="exa-...">
                    <small class="key-hint">Use <code>/search query</code> to search the web. <a href="https://dashboard.exa.ai/api-keys" target="_blank">Get API key</a></small>
                </div>
                
                <button id="save-settings-btn" class="primary-btn">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Session Picker Modal -->
    <div id="session-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Sessions</h2>
                <button class="modal-close" id="session-close">&times;</button>
            </div>
            <div class="modal-body">
                <button id="new-session-btn" class="primary-btn">+ New Session</button>
                <div id="session-list" class="session-list">
                    <!-- Sessions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="import-file-input" accept=".canvaschat" style="display: none;">

    <!-- Matrix Axis Confirmation Modal -->
    <div id="matrix-modal" class="modal" style="display: none;">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2>Create Matrix</h2>
                <button class="modal-close" id="matrix-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="matrix-context-group">
                    <label for="matrix-context">Matrix Context</label>
                    <input type="text" id="matrix-context" placeholder="e.g., evaluate ideas against criteria" readonly>
                </div>
                
                <div class="matrix-axes">
                    <div class="matrix-axis">
                        <div class="axis-header">
                            <h3>Rows</h3>
                            <span class="axis-count" id="row-count">0 items</span>
                        </div>
                        <ul class="axis-items" id="row-items">
                            <!-- Row items will be populated here -->
                        </ul>
                    </div>
                    
                    <div class="matrix-swap">
                        <button id="swap-axes-btn" class="icon-btn" title="Swap Axes">‚áÑ</button>
                    </div>
                    
                    <div class="matrix-axis">
                        <div class="axis-header">
                            <h3>Columns</h3>
                            <span class="axis-count" id="col-count">0 items</span>
                        </div>
                        <ul class="axis-items" id="col-items">
                            <!-- Column items will be populated here -->
                        </ul>
                    </div>
                </div>
                
                <div class="matrix-warning" id="matrix-warning" style="display: none;">
                    ‚ö†Ô∏è Maximum 10 items per axis. Some items have been truncated.
                </div>
                
                <div class="modal-actions">
                    <button id="matrix-cancel-btn" class="secondary-btn">Cancel</button>
                    <button id="matrix-create-btn" class="primary-btn">Create Matrix</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cell Detail Modal -->
    <div id="cell-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cell Details</h2>
                <button class="modal-close" id="cell-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="cell-detail-row">
                    <label>Row:</label>
                    <div class="cell-detail-content" id="cell-row-item"></div>
                </div>
                <div class="cell-detail-row">
                    <label>Column:</label>
                    <div class="cell-detail-content" id="cell-col-item"></div>
                </div>
                <div class="cell-detail-row">
                    <label>Evaluation:</label>
                    <div class="cell-detail-content cell-evaluation" id="cell-content"></div>
                </div>
                <div class="modal-actions">
                    <button id="cell-close-btn" class="secondary-btn">Close</button>
                    <button id="cell-pin-btn" class="primary-btn">üìå Pin to Canvas</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/storage.js"></script>
    <script src="/static/js/graph.js"></script>
    <script src="/static/js/canvas.js"></script>
    <script src="/static/js/chat.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
